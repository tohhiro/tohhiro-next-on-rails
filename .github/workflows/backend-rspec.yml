name: Backend RSpec

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    backend-rspec:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: blog_api_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        env:
            DATABASE_HOST: localhost
            DATABASE_USERNAME: postgres
            DATABASE_PASSWORD: postgres
            RAILS_ENV: test

        steps:
            - name: Checkout code
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Check for backend changes
              uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
              id: filter
              with:
                  filters: |
                      backend:
                        - 'blog-api/**'
                        - '.github/workflows/backend-rspec.yml'

            - name: Setup Ruby
              if: steps.filter.outputs.backend == 'true'
              uses: ruby/setup-ruby@a2bbe5b1b236842c1cb7dd11e8e3b51e0a616acc # v1.202.0
              with:
                  ruby-version: "3.3.6"
                  bundler-cache: true
                  working-directory: blog-api

            - name: Setup database
              if: steps.filter.outputs.backend == 'true'
              working-directory: blog-api
              run: |
                  bin/rails db:create
                  bin/rails db:migrate

            - name: Run RSpec
              if: steps.filter.outputs.backend == 'true'
              working-directory: blog-api
              run: bundle exec rspec
